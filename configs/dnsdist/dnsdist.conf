setTCPRecvTimeout(30) 
setTCPSendTimeout(30)
setVerbose(true)

newServer({
  address="172.20.0.10:53",
  name="pihole", 
  healthCheckMode='lazy', 
  checkInterval=1, 
  lazyHealthCheckFailedInterval=30, 
  rise=2, 
  maxCheckFailures=3, 
  lazyHealthCheckThreshold=30, 
  lazyHealthCheckSampleSize=100,  
  lazyHealthCheckMinSampleCount=10, 
  lazyHealthCheckMode='TimeoutOnly'
})

setACL({"0.0.0.0/0", "::/0"})

-- Use shared certificate location with proper permissions
local cert_path = "/shared-certs/dns.crt"
local key_path = "/shared-certs/dns.key"

print("Looking for certificate at: " .. cert_path)
print("Looking for key at: " .. key_path)

-- Check if files exist before trying to load them
local cert_file = io.open(cert_path, "r")
local key_file = io.open(key_path, "r")

if cert_file and key_file then
  cert_file:close()
  key_file:close()
  print("Certificate files found, setting up DoH and DoT")
  
  addDOHLocal("0.0.0.0:443", cert_path, key_path, "/dns-query")
  addTLSLocal("0.0.0.0:853", cert_path, key_path)
  addTLSLocal("[::]:853", cert_path, key_path)
else
  print("Certificate files not found!")
  if cert_file then cert_file:close() end
  if key_file then key_file:close() end
  print("Falling back to plain DNS only")
end

addLocal("0.0.0.0:53")
addLocal("[::]:53")

addAction(AllRule(), LogAction("/dev/stdout", false, false, true, false, false))

function healthCheck()
  return "OK"
end